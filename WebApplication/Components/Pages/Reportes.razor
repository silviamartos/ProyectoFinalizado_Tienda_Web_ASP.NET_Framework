@namespace WebApplication.Components.Pages.Reportes

@page "/Reportes"
@rendermode InteractiveServer
@using Controllers
@using DataBase
@using Dominio
@using System.Data
@using System.Globalization
@inject NavigationManager NavigationManager
@inject ILogger<Reportes> Logger

<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <div style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center; background-color: #fff; margin-bottom: 20px; border: 1px solid #dee2e6;">
        <div style="background-color: #007bff; padding: 10px; border-top-left-radius: 8px; border-top-right-radius: 8px; color: white;">
            <h2 style="margin: 0; color: white;">Reporte de ventas</h2>
        </div>
        <div style="padding: 20px;">
            <button class="btn btn-primary" @onclick="Inicio_Click"
                style="background-color: #007bff; border-color: #007bff; color: #fff; border-radius: 4px; padding: 10px 20px; font-size: 16px; cursor: pointer;">Volver</button>
        </div>
        <div style="background-color: #f8f9fa; padding: 10px; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;">
        </div>
    </div>
</div>

<div style="display: flex; align-items: center; margin-bottom: 20px;">
    <label for="barraAño" style="font-size: 18px; margin-right: 10px;">Buscar año:</label>
    <select id="barraAño" class="form-control" value="@selectedYear"
        style="width: 120px; padding: 10px; border-radius: 4px; border: 1px solid #ced4da;"
        @onchange="BarraAño_SelectedIndexChanged">
        @if (años != null)
        {
            @foreach (var año in años)
            {
                <option value="@año">@año</option>
            }
        }
    </select>
</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        var chartData = window.chartData || [];
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Topping');
        data.addColumn('number', 'Mes');
        data.addRows(chartData);

        var options = {
            title: 'Reporte de ventas',
            width: '100%',
            height: 400,
            legend: { position: 'none' },
            chartArea: { width: '80%' }
        };

        var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
        chart.draw(data, options);
    }

    window.redrawChart = function (chartDataJson) {
        window.chartData = JSON.parse(chartDataJson);
        drawChart();
    };
</script>

<div style="border: 1px solid #ddd; border-radius: 8px; background-color: #fff; padding: 20px;">
    <div id="chart_div" style="width: 100%; height: 400px; margin-bottom: 20px;overflow:auto"></div>
    <div style="overflow: scroll; height: 340px">
        <h5 style="margin-top: 0;">Detalles:</h5>
        <table class="table" style="width: 100%; border-collapse: collapse; margin: 0; border: 1px solid #ddd;">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                @if (filteredRegistros != null)
                {
                    @foreach (var registro in filteredRegistros)
                    {
                        <tr>
                            <td>@registro.Producto</td>
                            <td>@registro.Cantidad</td>
                            <td>@registro.Fecha</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    public List<RegistroDeVentas> registros { get; set; }
    private List<RegistroDeVentas> filteredRegistros { get; set; }
    private List<int> años { get; set; }
    private string selectedYear { get; set; }

    protected override void OnInitialized()
    {
        try
        {
            Controler control = new Controler();
            registros = control.Registro();

            List<string> fechas = new List<string>();
            años = new List<int>();

            foreach (var item in registros)
            {
                fechas.Add(item.Fecha);
            }

            años = fechas.Select(x => DateTime.ParseExact(x, "dd-MM-yyyy", CultureInfo.InvariantCulture).Year)
                         .Distinct()
                         .OrderByDescending(año => año)
                         .ToList();

            if (años.Count > 0)
            {
                selectedYear = años[0].ToString();
                filteredRegistros = registros.FindAll(x => x.Fecha.Contains("-" + selectedYear + ""));
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in OnInitialized");
            NavigationManager.NavigateTo("/Error", false);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                string chartData = ObtenerDatos();
                await JSRuntime.InvokeVoidAsync("redrawChart", chartData);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error rendering chart");
            }
        }
    }

    [Inject]
    private IJSRuntime JSRuntime { get; set; }

    protected string ObtenerDatos()
    {
        try
        {
            List<decimal> RegistroXaño = new List<decimal>();
            DataTable Data = new DataTable();

            Data.Columns.Add(new DataColumn("Topping", typeof(string)));
            Data.Columns.Add(new DataColumn("Slices", typeof(decimal)));

            for (int i = 0; i < 12; i++)
            {
                RegistroXaño.Add(0);
            }

            foreach (var item in registros)
            {
                if (item.Fecha.Contains("-" + selectedYear))
                {
                    if (item.Fecha.Contains("-01-"))
                    {
                        RegistroXaño[0] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-02-"))
                    {
                        RegistroXaño[1] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-03-"))
                    {
                        RegistroXaño[2] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-04-"))
                    {
                        RegistroXaño[3] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-05-"))
                    {
                        RegistroXaño[4] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-06-"))
                    {
                        RegistroXaño[5] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-07-"))
                    {
                        RegistroXaño[6] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-08-"))
                    {
                        RegistroXaño[7] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-09-"))
                    {
                        RegistroXaño[8] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-10-"))
                    {
                        RegistroXaño[9] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-11-"))
                    {
                        RegistroXaño[10] += item.Precio;
                    }
                    else if (item.Fecha.Contains("-12-"))
                    {
                        RegistroXaño[11] += item.Precio;
                    }
                }
            }

            Data.Rows.Add(new object[] { "Enero", decimal.Parse(RegistroXaño[0].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Febrero", decimal.Parse(RegistroXaño[1].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Marzo", decimal.Parse(RegistroXaño[2].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Abril", decimal.Parse(RegistroXaño[3].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Mayo", decimal.Parse(RegistroXaño[4].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Junio", decimal.Parse(RegistroXaño[5].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Julio", decimal.Parse(RegistroXaño[6].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Agosto", decimal.Parse(RegistroXaño[7].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Septiembre", decimal.Parse(RegistroXaño[8].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Octubre", decimal.Parse(RegistroXaño[9].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Noviembre", decimal.Parse(RegistroXaño[10].ToString("0.##")) });
            Data.Rows.Add(new object[] { "Diciembre", decimal.Parse(RegistroXaño[11].ToString("0.##")) });

            string stringDatos = "[";

            foreach (DataRow item in Data.Rows)
            {
                stringDatos = stringDatos + "[";
                stringDatos = stringDatos + "'" + item[0] + "'" + "," + item[1];
                stringDatos = stringDatos + "],";
            }
            stringDatos = stringDatos + "]";

            filteredRegistros = registros.FindAll(x => x.Fecha.Contains("-" + selectedYear + ""));

            return stringDatos;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in ObtenerDatos");
            NavigationManager.NavigateTo("/Error", false);
            return "[]";
        }
    }

    protected void Inicio_Click()
    {
        NavigationManager.NavigateTo("/Default", false);
    }

    protected async void BarraAño_SelectedIndexChanged(ChangeEventArgs e)
    {
        try
        {
            selectedYear = e.Value.ToString();
            string chartData = ObtenerDatos();
            await JSRuntime.InvokeVoidAsync("redrawChart", chartData);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in BarraAño_SelectedIndexChanged");
            NavigationManager.NavigateTo("/Error", false);
        }
    }
}